<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'Elden Ring Tracker' %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="view-desktop">

    <button id="mobile-nav-toggle" class="mobile-nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <span class="icon-open">☰</span> <span class="icon-close">✕</span>
    </button>
    <div id="mobile-overlay" class="mobile-overlay"></div>

    <div class="layout-container">
        <%- include('../../partials/sidebar-eldenring') %>

        <main class="content">
            <!-- REMOVIDO: Link Back to Games daqui -->
            <%- include('../../partials/header') %> 
            <%- include('../../partials/messages') %>

            <div class="page-controls-header">
                <h2>Elden Ring Tracker</h2>
                <div class="controls-right">
                    <div class="search-controls">
                        <form action="/search" method="GET">
                            <input type="search" id="search-term" name="q" placeholder="Search..." required minlength="3">
                            <button type="submit">Search</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Seções do Tracker -->
            <section id="overview-section" class="game-section hidden" data-section-title="Overview">
                 <div class="section-title-header"><h3>Overview</h3></div>
                 <% if (typeof overviewData !== 'undefined' && overviewData && overviewData.length > 0) { %><ul class="overview-area-list" style="list-style: none; padding: 0;"><% overviewData.forEach(areaData => { %><li class="overview-area-item"><h4><%= areaData.area_name %></h4><div class="accordion-item sub-accordion"><div class="item-header overview-subheader"><strong>Sites of Grace (<%= areaData.graces ? areaData.graces.length : 0 %>)</strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><% if (areaData.graces && areaData.graces.length > 0) { %><ul><% areaData.graces.forEach(grace => { %><li><%= grace.grace_name %></li><% }); %></ul><% } else { %><p class="no-notes">No sites of grace linked.</p><% } %></div></div><div class="accordion-item sub-accordion"><div class="item-header overview-subheader"><strong>Bosses (<%= areaData.bosses ? areaData.bosses.length : 0 %>)</strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><% if (areaData.bosses && areaData.bosses.length > 0) { %><ul><% areaData.bosses.forEach(boss => { %><li><%= boss.boss_name %></li><% }); %></ul><% } else { %><p class="no-notes">No bosses linked.</p><% } %></div></div><div class="accordion-item sub-accordion"><div class="item-header overview-subheader"><strong>Merchants (<%= areaData.merchants ? areaData.merchants.length : 0 %>)</strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><% if (areaData.merchants && areaData.merchants.length > 0) { %><ul><% areaData.merchants.forEach(merchant => { %><li><%= merchant.merchant_name %></li><% }); %></ul><% } else { %><p class="no-notes">No merchants linked.</p><% } %></div></div><div class="accordion-item sub-accordion"><div class="item-header overview-subheader"><strong>Area Notes</strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><% if (areaData.notes && areaData.notes.trim() !== '') { %><p style="white-space: pre-wrap;"><%= areaData.notes %></p><% } else { %><p class="no-notes">No notes for this area.</p><% } %></div></div></li><% }); %></ul><% } else { %><p class="no-data-message">No map areas added yet to show overview.</p><% } %>
            </section>
            <section id="map-areas-section" class="game-section hidden" data-section-title="Map Areas" data-add-form-id="add-area-form" data-edit-form-id="edit-area-form" data-item-selector=".accordion-item" data-url-prefix="/game/elden-ring/map-areas">
                 <div class="section-title-header"><h3>Map Areas</h3><button class="button-add-toggle" data-form-id="add-area-form">Add New</button></div>
                 <form id="add-area-form" action="/game/elden-ring/map-areas" method="POST" class="add-item-form hidden"><div class="form-group full-width"><label>New Area Name</label><input type="text" name="area_name" required></div><div class="form-group full-width"><label>Notes</label><textarea name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Add Area</button><button type="button" class="button-cancel-add">Cancel</button></div></form>
                 <form id="edit-area-form" action="" method="POST" class="add-item-form hidden" data-base-action="/game/elden-ring/map-areas/"><input type="hidden" name="_method" value="PUT"><h4 class="form-title">Edit Map Area</h4><div class="form-group full-width"><label for="edit_area_name">Area Name</label><input type="text" id="edit_area_name" name="area_name" required></div><div class="form-group full-width"><label for="edit_area_notes">Notes</label><textarea id="edit_area_notes" name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Save Changes</button><button type="button" class="button-cancel-edit">Cancel</button></div></form>
                 <% if (typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { %> <ul class="accordion-list"> <% mapAreas.forEach(area => { %><li class="accordion-item" data-id="<%= area.area_id %>" data-name="<%= area.area_name %>" data-notes="<%= area.notes || '' %>"><div class="item-header"><strong><%= area.area_name %></strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><p><strong>Notes:</strong></p><% if (area.notes && area.notes.trim() !== '') { %><p><%= area.notes %></p><% } else { %><p class="no-notes">No notes added.</p><% } %><div class="item-actions"><button class="button-edit">Edit</button><button class="button-delete">Delete</button></div></div></li><% }); %> </ul> <% } %> <p class="no-data-message <%= (typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) ? 'hidden' : '' %>">No map areas added yet.</p>
            </section>
            <section id="graces-section" class="game-section hidden" data-section-title="Sites of Grace" data-add-form-id="add-grace-form" data-edit-form-id="edit-grace-form" data-item-selector=".accordion-item" data-url-prefix="/game/elden-ring/graces">
                 <div class="section-title-header"><h3>Sites of Grace</h3><button class="button-add-toggle" data-form-id="add-grace-form">Add New</button></div>
                 <form id="add-grace-form" action="/game/elden-ring/graces" method="POST" class="add-item-form hidden"><div class="form-group"><label>New Site of Grace</label><input type="text" name="grace_name" required></div><div class="form-group"><label>Map Area</label><select name="map_area_id"><option value="">-- Select Area --</option><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) {%><% mapAreas.forEach(area => {%><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); %><% } %></select></div><div class="form-group full-width"><label>Notes</label><textarea name="notes" rows="1"></textarea></div><div class="form-actions"><button type="submit">Add Grace</button><button type="button" class="button-cancel-add">Cancel</button></div></form>
                 <form id="edit-grace-form" action="" method="POST" class="add-item-form hidden" data-base-action="/game/elden-ring/graces/"><input type="hidden" name="_method" value="PUT"><h4 class="form-title">Edit Site of Grace</h4><div class="form-group full-width"><label for="edit_grace_name">Grace Name</label><input type="text" id="edit_grace_name" name="grace_name" required></div><div class="form-group"><label for="edit_grace_map_area_id">Map Area</label><select id="edit_grace_map_area_id" name="map_area_id"><option value="">-- Select Area --</option><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) {%><% mapAreas.forEach(area => {%><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); %><% } %></select></div><div class="form-group full-width"><label for="edit_grace_notes">Notes</label><textarea id="edit_grace_notes" name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Save Changes</button><button type="button" class="button-cancel-edit">Cancel</button></div></form>
                 <% if (typeof graces !== 'undefined' && graces && graces.length > 0) { %> <ul class="accordion-list"> <% graces.forEach(grace => { %><li class="accordion-item" data-id="<%= grace.grace_id %>" data-name="<%= grace.grace_name %>" data-notes="<%= grace.notes || '' %>" data-map_area_id="<%= grace.map_area_id || '' %>"><div class="item-header"><strong><%= grace.grace_name %></strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><p><strong>Map Area:</strong> <%= grace.area_name || 'N/A' %></p><p><strong>Notes:</strong></p><% if (grace.notes && grace.notes.trim() !== '') { %><p><%= grace.notes %></p><% } else { %><p class="no-notes">No notes added.</p><% } %><div class="item-actions"><button class="button-edit">Edit</button><button class="button-delete">Delete</button></div></div></li><% }); %> </ul> <% } %> <p class="no-data-message <%= (typeof graces !== 'undefined' && graces && graces.length > 0) ? 'hidden' : '' %>">No sites of grace added yet.</p>
            </section>
            <section id="bosses-section" class="game-section hidden" data-section-title="Bosses" data-add-form-id="add-boss-form" data-edit-form-id="edit-boss-form" data-item-selector=".accordion-item" data-url-prefix="/game/elden-ring/bosses">
                <div class="section-title-header"><h3>Bosses</h3><button class="button-add-toggle" data-form-id="add-boss-form">Add New</button></div><form id="add-boss-form" action="/game/elden-ring/bosses" method="POST" class="add-item-form hidden"><div class="form-group"><label>Boss Name</label><input type="text" name="boss_name" required></div><div class="form-group"><label>Map Area</label><select name="map_area_id"><option value="">-- Select Area --</option><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group"><label>Nearest Grace</label><select name="nearest_grace_id"><option value="">-- Select Grace --</option><% if(typeof graces !== 'undefined' && graces && graces.length > 0) { graces.forEach(grace => { %><option value="<%= grace.grace_id %>"><%= grace.grace_name %></option><% }); } %></select></div><div class="form-group"><label>Item Drops</label><select name="dropped_item_ids" multiple><% if(typeof items !== 'undefined' && items && items.length > 0) { items.forEach(item => { %><option value="<%= item.item_id %>"><%= item.item_name %></option><% }); } %></select></div><div class="form-group full-width"><label>Notes</label><textarea name="notes" rows="2"></textarea></div><div class="form-group-checkbox"><input type="checkbox" name="is_defeated" value="true" id="add_boss_defeated"><label for="add_boss_defeated"> Defeated</label></div><div class="form-actions"><button type="submit">Add Boss</button><button type="button" class="button-cancel-add">Cancel</button></div></form><form id="edit-boss-form" action="" method="POST" class="add-item-form hidden" data-base-action="/game/elden-ring/bosses/"><input type="hidden" name="_method" value="PUT"><h4 class="form-title">Edit Boss</h4><div class="form-group"><label for="edit_boss_name">Boss Name</label><input type="text" id="edit_boss_name" name="boss_name" required></div><div class="form-group"><label for="edit_boss_map_area_id">Map Area</label><select id="edit_boss_map_area_id" name="map_area_id"><option value="">-- Select Area --</option><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group"><label for="edit_boss_nearest_grace_id">Nearest Grace</label><select id="edit_boss_nearest_grace_id" name="nearest_grace_id"><option value="">-- Select Grace --</option><% if(typeof graces !== 'undefined' && graces && graces.length > 0) { graces.forEach(grace => { %><option value="<%= grace.grace_id %>"><%= grace.grace_name %></option><% }); } %></select></div><div class="form-group"><label for="edit_boss_dropped_item_ids">Item Drops</label><select id="edit_boss_dropped_item_ids" name="dropped_item_ids" multiple><% if(typeof items !== 'undefined' && items && items.length > 0) { items.forEach(item => { %><option value="<%= item.item_id %>"><%= item.item_name %></option><% }); } %></select></div><div class="form-group full-width"><label for="edit_boss_notes">Notes</label><textarea id="edit_boss_notes" name="notes" rows="2"></textarea></div><div class="form-group-checkbox"><input type="checkbox" name="is_defeated" value="true" id="edit_boss_defeated"><label for="edit_boss_defeated"> Defeated</label></div><div class="form-actions"><button type="submit">Save Changes</button><button type="button" class="button-cancel-edit">Cancel</button></div></form><% if (typeof bosses !== 'undefined' && bosses && bosses.length > 0) { %><ul class="accordion-list" id="bosses-list"><% bosses.forEach(boss => { %><li class="accordion-item" data-id="<%= boss.boss_id %>" data-name="<%= boss.boss_name %>" data-notes="<%= boss.notes || '' %>" data-defeated="<%= boss.is_defeated %>" data-map_area_id="<%= boss.map_area_id || '' %>" data-nearest_grace_id="<%= boss.nearest_grace_id || '' %>" data-dropped_item_ids="<%= JSON.stringify(boss.dropped_items ? boss.dropped_items.map(i => i.item_id) : []) %>"><div class="item-header <%= boss.is_defeated ? 'defeated' : '' %>"><strong><%= boss.boss_name %></strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><p><strong>Status:</strong> <span class="status-indicator <%= boss.is_defeated ? 'status-defeated' : 'status-not-defeated' %>"><%= boss.is_defeated ? 'Defeated' : 'Pending' %></span></p><p><strong>Map Area:</strong> <%= boss.area_name || 'N/A' %></p><p><strong>Nearest Grace:</strong> <%= boss.grace_name || 'N/A' %></p><p><strong>Drops:</strong> <% if(boss.dropped_items && boss.dropped_items.length > 0){ boss.dropped_items.forEach((item, index) => { %><%= item.item_name %><%=(index < boss.dropped_items.length - 1) ? ', ' : '' %><% }); } else { %>None<% } %></p><p><strong>Notes:</strong></p> <% if (boss.notes && boss.notes.trim() !== '') { %><p><%= boss.notes %></p><% } else { %><p class="no-notes">No notes added.</p><% } %><div class="item-actions"><button class="button-edit">Edit</button><button class="button-delete">Delete</button></div></div></li><% }); %></ul><% } %><p class="no-data-message <%= (typeof bosses !== 'undefined' && bosses && bosses.length > 0) ? 'hidden' : '' %>" id="no-bosses-message">No bosses added yet.</p>
            </section>
            <section id="enemies-section" class="game-section hidden" data-section-title="Enemies" data-add-form-id="add-enemy-form" data-edit-form-id="edit-enemy-form" data-item-selector=".accordion-item" data-url-prefix="/game/elden-ring/enemies">
                 <div class="section-title-header"><h3>Enemies</h3><button class="button-add-toggle" data-form-id="add-enemy-form">Add New</button></div><form id="add-enemy-form" action="/game/elden-ring/enemies" method="POST" class="add-item-form hidden"><div class="form-group"><label>Enemy Name</label><input type="text" name="enemy_name" required></div><div class="form-group"><label>Map Areas</label><select name="location_area_ids" multiple><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group"><label>Item Drops</label><select name="dropped_item_ids" multiple><% if(typeof items !== 'undefined' && items && items.length > 0) { items.forEach(item => { %><option value="<%= item.item_id %>"><%= item.item_name %></option><% }); } %></select></div><div class="form-group full-width"><label>Notes</label><textarea name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Add Enemy</button><button type="button" class="button-cancel-add">Cancel</button></div></form><form id="edit-enemy-form" action="" method="POST" class="add-item-form hidden" data-base-action="/game/elden-ring/enemies/"><input type="hidden" name="_method" value="PUT"><h4 class="form-title">Edit Enemy</h4><div class="form-group"><label for="edit_enemy_name">Enemy Name</label><input type="text" id="edit_enemy_name" name="enemy_name" required></div><div class="form-group"><label for="edit_enemy_location_area_ids">Map Areas</label><select id="edit_enemy_location_area_ids" name="location_area_ids" multiple><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group"><label for="edit_enemy_dropped_item_ids">Item Drops</label><select id="edit_enemy_dropped_item_ids" name="dropped_item_ids" multiple><% if(typeof items !== 'undefined' && items && items.length > 0) { items.forEach(item => { %><option value="<%= item.item_id %>"><%= item.item_name %></option><% }); } %></select></div><div class="form-group full-width"><label for="edit_enemy_notes">Notes</label><textarea id="edit_enemy_notes" name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Save Changes</button><button type="button" class="button-cancel-edit">Cancel</button></div></form><% if (typeof enemies !== 'undefined' && enemies && enemies.length > 0) { %><ul class="accordion-list"><% enemies.forEach(enemy => { %><li class="accordion-item" data-id="<%= enemy.enemy_id %>" data-name="<%= enemy.enemy_name %>" data-notes="<%= enemy.notes || '' %>" data-location_details="<%= enemy.location_details || '' %>" data-location_area_ids="<%= JSON.stringify(enemy.locations ? enemy.locations.map(l => l.area_id) : []) %>" data-dropped_item_ids="<%= JSON.stringify(enemy.dropped_items ? enemy.dropped_items.map(i => i.item_id) : []) %>"><div class="item-header"><strong><%= enemy.enemy_name %></strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><p><strong>Locations:</strong> <% if(enemy.locations && enemy.locations.length > 0){ enemy.locations.forEach((loc, index) => { %><%= loc.area_name %><%=(index < enemy.locations.length - 1) ? ', ' : '' %><% }); } else { %>N/A<% } %></p><% if (enemy.location_details) { %><p><strong>Location Details:</strong> <%= enemy.location_details %></p><% } %><p><strong>Drops:</strong> <% if(enemy.dropped_items && enemy.dropped_items.length > 0){ enemy.dropped_items.forEach((item, index) => { %><%= item.item_name %><%=(index < enemy.dropped_items.length - 1) ? ', ' : '' %><% }); } else { %>None<% } %></p><p><strong>Notes:</strong></p> <% if (enemy.notes && enemy.notes.trim() !== '') { %><p><%= enemy.notes %></p><% } else { %><p class="no-notes">No notes added.</p><% } %><div class="item-actions"><button class="button-edit">Edit</button><button class="button-delete">Delete</button></div></div></li><% }); %></ul><% } %><p class="no-data-message <%= (typeof enemies !== 'undefined' && enemies && enemies.length > 0) ? 'hidden' : '' %>">No enemies added yet.</p>
            </section>
            <section id="merchants-section" class="game-section hidden" data-section-title="Merchants" data-add-form-id="add-merchant-form" data-edit-form-id="edit-merchant-form" data-item-selector=".accordion-item" data-url-prefix="/game/elden-ring/merchants">
                 <div class="section-title-header"><h3>Merchants</h3><button class="button-add-toggle" data-form-id="add-merchant-form">Add New</button></div><form id="add-merchant-form" action="/game/elden-ring/merchants" method="POST" class="add-item-form hidden"><div class="form-group"><label>Merchant Name</label><input type="text" name="merchant_name" required></div><div class="form-group"><label>Map Area</label><select name="map_area_id"><option value="">-- Select Area --</option><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group"><label>Nearest Grace</label><select name="nearest_grace_id"><option value="">-- Select Grace --</option><% if(typeof graces !== 'undefined' && graces && graces.length > 0) { graces.forEach(grace => { %><option value="<%= grace.grace_id %>"><%= grace.grace_name %></option><% }); } %></select></div><div class="form-group"><label>Items Sold (Inventory)</label><select name="inventory_item_ids" multiple><% if(typeof items !== 'undefined' && items && items.length > 0) { items.forEach(item => { %><option value="<%= item.item_id %>"><%= item.item_name %></option><% }); } %></select></div><div class="form-group full-width"><label>Notes</label><textarea name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Add Merchant</button><button type="button" class="button-cancel-add">Cancel</button></div></form><form id="edit-merchant-form" action="" method="POST" class="add-item-form hidden" data-base-action="/game/elden-ring/merchants/"><input type="hidden" name="_method" value="PUT"><h4 class="form-title">Edit Merchant</h4><div class="form-group"><label for="edit_merchant_name">Merchant Name</label><input type="text" id="edit_merchant_name" name="merchant_name" required></div><div class="form-group"><label for="edit_merchant_map_area_id">Map Area</label><select id="edit_merchant_map_area_id" name="map_area_id"><option value="">-- Select Area --</option><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group"><label for="edit_merchant_nearest_grace_id">Nearest Grace</label><select id="edit_merchant_nearest_grace_id" name="nearest_grace_id"><option value="">-- Select Grace --</option><% if(typeof graces !== 'undefined' && graces && graces.length > 0) { graces.forEach(grace => { %><option value="<%= grace.grace_id %>"><%= grace.grace_name %></option><% }); } %></select></div><div class="form-group"><label for="edit_merchant_inventory_item_ids">Items Sold (Inventory)</label><select id="edit_merchant_inventory_item_ids" name="inventory_item_ids" multiple><% if(typeof items !== 'undefined' && items && items.length > 0) { items.forEach(item => { %><option value="<%= item.item_id %>"><%= item.item_name %></option><% }); } %></select></div><div class="form-group full-width"><label for="edit_merchant_notes">Notes</label><textarea id="edit_merchant_notes" name="notes" rows="2"></textarea></div><div class="form-actions"><button type="submit">Save Changes</button><button type="button" class="button-cancel-edit">Cancel</button></div></form><% if (typeof merchants !== 'undefined' && merchants && merchants.length > 0) { %><ul class="accordion-list"><% merchants.forEach(merchant => { %><li class="accordion-item" data-id="<%= merchant.merchant_id %>" data-name="<%= merchant.merchant_name %>" data-notes="<%= merchant.notes || '' %>" data-map_area_id="<%= merchant.map_area_id || '' %>" data-nearest_grace_id="<%= merchant.nearest_grace_id || '' %>" data-location_details="<%= merchant.location_details || '' %>" data-inventory_item_ids="<%= JSON.stringify(merchant.inventory ? merchant.inventory.map(i=>i.item_id) : []) %>"><div class="item-header"><strong><%= merchant.merchant_name %></strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><p><strong>Map Area:</strong> <%= merchant.area_name || 'N/A' %></p><p><strong>Nearest Grace:</strong> <%= merchant.grace_name || 'N/A' %></p><% if (merchant.location_details) { %><p><strong>Location Details:</strong> <%= merchant.location_details %></p><% } %><p><strong>Inventory:</strong> <% if(merchant.inventory && merchant.inventory.length > 0){ merchant.inventory.forEach((item, index) => { %><%= item.item_name %><%=(index < merchant.inventory.length - 1) ? ', ' : '' %><% }); } else { %>Unknown<% } %></p><p><strong>Notes:</strong></p> <% if (merchant.notes && merchant.notes.trim() !== '') { %><p><%= merchant.notes %></p><% } else { %><p class="no-notes">No notes added.</p><% } %><div class="item-actions"><button class="button-edit">Edit</button><button class="button-delete">Delete</button></div></div></li><% }); %></ul><% } %><p class="no-data-message <%= (typeof merchants !== 'undefined' && merchants && merchants.length > 0) ? 'hidden' : '' %>">No merchants added yet.</p>
            </section>
            <section id="items-section" class="game-section hidden" data-section-title="Items" data-add-form-id="add-item-form" data-edit-form-id="edit-item-form" data-item-selector=".accordion-item" data-url-prefix="/game/elden-ring/items">
                 <div class="section-title-header"><h3>Items</h3><button class="button-add-toggle" data-form-id="add-item-form">Add New</button></div><form id="add-item-form" action="/game/elden-ring/items" method="POST" class="add-item-form hidden"><div class="form-group"><label>Item Name</label><input type="text" name="item_name" required></div><div class="form-group"><label>Type</label><select name="item_type"><option value="">-- Select Type --</option><option value="WEAPON">Weapon</option><option value="ARMOUR">Armour</option><option value="TALISMAN">Talisman</option><option value="ASH_OF_WAR">Ash of War</option><option value="SPIRIT_ASH">Spirit Ash</option><option value="SORCERY">Sorcery</option><option value="INCANTATION">Incantation</option><option value="CRAFTING_MATERIAL">Crafting Material</option><option value="CONSUMABLE">Consumable</option><option value="UPGRADE_MATERIAL">Upgrade Material</option><option value="KEY_ITEM">Key Item</option><option value="OTHER">Other</option></select></div><div class="form-group"><label>Found In Areas</label><select name="location_area_ids" multiple><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group full-width"><label>Notes</label><textarea name="notes" rows="2"></textarea></div><div class="form-group-checkbox"><input type="checkbox" name="is_obtained" value="true" id="add_item_obtained"><label for="add_item_obtained"> Obtained</label></div><div class="form-actions"><button type="submit">Add Item</button><button type="button" class="button-cancel-add">Cancel</button></div></form><form id="edit-item-form" action="" method="POST" class="add-item-form hidden" data-base-action="/game/elden-ring/items/"><input type="hidden" name="_method" value="PUT"><h4 class="form-title">Edit Item</h4><div class="form-group"><label for="edit_item_name">Item Name</label><input type="text" id="edit_item_name" name="item_name" required></div><div class="form-group"><label for="edit_item_type">Type</label><select id="edit_item_type" name="item_type"><option value="">-- Select Type --</option><option value="WEAPON">Weapon</option><option value="ARMOUR">Armour</option><option value="TALISMAN">Talisman</option><option value="ASH_OF_WAR">Ash of War</option><option value="SPIRIT_ASH">Spirit Ash</option><option value="SORCERY">Sorcery</option><option value="INCANTATION">Incantation</option><option value="CRAFTING_MATERIAL">Crafting Material</option><option value="CONSUMABLE">Consumable</option><option value="UPGRADE_MATERIAL">Upgrade Material</option><option value="KEY_ITEM">Key Item</option><option value="OTHER">Other</option></select></div><div class="form-group"><label for="edit_item_location_area_ids">Found In Areas</label><select id="edit_item_location_area_ids" name="location_area_ids" multiple><% if(typeof mapAreas !== 'undefined' && mapAreas && mapAreas.length > 0) { mapAreas.forEach(area => { %><option value="<%= area.area_id %>"><%= area.area_name %></option><% }); } %></select></div><div class="form-group full-width"><label for="edit_item_notes">Notes</label><textarea id="edit_item_notes" name="notes" rows="2"></textarea></div><div class="form-group-checkbox"><input type="checkbox" name="is_obtained" value="true" id="edit_item_obtained"><label for="edit_item_obtained"> Obtained</label></div><div class="form-actions"><button type="submit">Save Changes</button><button type="button" class="button-cancel-edit">Cancel</button></div></form><% if (typeof items !== 'undefined' && items && items.length > 0) { %><ul class="accordion-list"><% items.forEach(item => { %><li class="accordion-item" data-id="<%= item.item_id %>" data-name="<%= item.item_name %>" data-item_type="<%= item.item_type || '' %>" data-notes="<%= item.notes || '' %>" data-is_obtained="<%= item.is_obtained %>" data-location_details="<%= item.location_details || '' %>" data-location_area_ids="<%= JSON.stringify(item.locations ? item.locations.map(l=>l.area_id) : []) %>"><div class="item-header <%= item.is_obtained ? 'defeated' : '' %>"><strong><%= item.item_name %></strong><span class="accordion-indicator">▼</span></div><div class="item-details-content"><p><strong>Status:</strong> <span class="status-indicator <%= item.is_obtained ? 'status-defeated' : 'status-not-defeated' %>"><%= item.is_obtained ? 'Obtained' : 'Not Obtained' %></span></p><p><strong>Type:</strong> <%= item.item_type ? item.item_type.replace(/_/g, ' ') : 'N/A' %></p><p><strong>Found In:</strong> <% if(item.locations && item.locations.length > 0){ item.locations.forEach((loc, index) => { %><%= loc.area_name %><%=(index < item.locations.length - 1) ? ', ' : '' %><% }); } else { %>N/A<% } %></p><% if (item.location_details) { %><p><strong>Location Details:</strong> <%= item.location_details %></p><% } %><p><strong>Dropped By (Boss):</strong> <% if(item.dropped_by_bosses && item.dropped_by_bosses.length > 0){ item.dropped_by_bosses.forEach((b, index) => { %><%= b.boss_name %><%=(index < item.dropped_by_bosses.length - 1) ? ', ' : '' %><% }); } else { %>N/A<% } %></p><p><strong>Dropped By (Enemy):</strong> <% if(item.dropped_by_enemies && item.dropped_by_enemies.length > 0){ item.dropped_by_enemies.forEach((e, index) => { %><%= e.enemy_name %><%=(index < item.dropped_by_enemies.length - 1) ? ', ' : '' %><% }); } else { %>N/A<% } %></p><p><strong>Sold By:</strong> <% if(item.sold_by_merchants && item.sold_by_merchants.length > 0){ item.sold_by_merchants.forEach((m, index) => { %><%= m.merchant_name %><%=(index < item.sold_by_merchants.length - 1) ? ', ' : '' %><% }); } else { %>N/A<% } %></p><p><strong>Notes:</strong></p> <% if (item.notes && item.notes.trim() !== '') { %><p><%= item.notes %></p><% } else { %><p class="no-notes">No notes added.</p><% } %><div class="item-actions"><button class="button-edit">Edit</button><button class="button-delete">Delete</button></div></div></li><% }); %></ul><% } %><p class="no-data-message <%= (typeof items !== 'undefined' && items && items.length > 0) ? 'hidden' : '' %>">No items added yet.</p>
            </section>

            <!-- Footer -->
            <%- include('../../partials/footer') %>

        </main>
    </div>

    <!-- Scripts -->
     <script src="/js/script.js" defer></script>
     <script src="/js/dropdown.js" defer></script>
     <script src="/js/theme-switcher.js" defer></script>
     <script src="/js/view-switcher.js" defer></script>
     <script src="/js/eldenring-tracker.js" defer></script>

</body>
</html>